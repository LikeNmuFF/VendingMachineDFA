<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vending Machine Simulation - Automata Theory</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü•§ Vending Machine Simulation</h1>
            <p class="subtitle">Finite State Machine Implementation - Automata Theory CS 109</p>
        </header>

        <div class="machine-wrapper">
            <div class="vending-machine">
                <div class="machine-header">SUPER VEND 3000</div>
                
                <div class="display-panel">
                    <div class="display-row">
                        <span class="display-label">Balance:</span>
                        <span class="display-value" id="balanceDisplay">‚Ç±0.00</span>
                    </div>
                    <div class="display-row">
                        <span class="display-label">Selected Item:</span>
                        <span class="display-value" id="selectedItemDisplay">-</span>
                    </div>
                    <div class="display-row">
                        <span class="display-label">Item Price:</span>
                        <span class="display-value" id="itemPriceDisplay">‚Ç±0.00</span>
                    </div>
                </div>

                <div class="state-display">
                    <div class="state-label">Current State:</div>
                    <div class="state-value" id="currentState">IDLE</div>
                </div>

                <h2 class="section-title">Products Available</h2>
                <div class="products-grid" id="productsGrid">
                    <!-- Products will be generated by JavaScript -->
                </div>

                <div class="inventory-panel">
                    <h3 class="section-title">üì¶ Inventory Status</h3>
                    <div id="inventoryDisplay">
                        <!-- Inventory items will be displayed here -->
                    </div>
                </div>

                <div class="dispensing-animation" id="dispensingAnimation">
                    <div class="item-icon">ü•§</div>
                </div>
            </div>

            <div class="control-panel">
                <div class="coin-section">
                    <h3 class="section-title">üí∞ Insert Coins</h3>
                    <div class="coins-grid">
                        <button class="coin-btn" data-amount="5" title="‚Ç±5">
                            <img src="5.png" alt="‚Ç±5 coin">
                        </button>
                        <button class="coin-btn" data-amount="10" title="‚Ç±10">
                            <img src="10.png" alt="‚Ç±10 coin">
                        </button>
                        <button class="coin-btn" data-amount="20" title="‚Ç±20">
                            <img src="20.png" alt="‚Ç±20 coin">
                        </button>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="action-btn" id="confirmBtn">
                        <span>‚úÖ</span> Confirm Purchase
                    </button>
                    <button class="action-btn cancel-btn" id="cancelBtn">
                        <span>‚ùå</span> Cancel
                    </button>
                    <button class="action-btn reset-btn" id="resetBtn">
                        <span>üîÑ</span> Reset Machine
                    </button>
                    <button class="action-btn" id="collectChangeBtn">
                        <span>üí∞</span> Collect Change
                    </button>
                    <button class="action-btn reset-btn" id="historyBtn">
                        <span>üìä</span> View History
                    </button>
                    <button class="action-btn cancel-btn" id="clearHistoryBtn">
                        <span>üóëÔ∏è</span> Clear History
                    </button>
                </div>

                <div class="output-section">
                    <h3 class="section-title">üìù Transaction Log</h3>
                    <div class="output-area" id="outputLog">
                        <!-- Log entries will appear here -->
                    </div>
                </div>

                <div class="change-area">
                    <h3 class="section-title">üí∞ Change Return</h3>
                    <div class="change-display" id="changeDisplay">
                        ‚Ç±0.00
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VendingMachine {
            constructor() {
                // States (Q)
                this.STATES = {
                    IDLE: 'IDLE',
                    COIN_INSERTED: 'COIN_INSERTED',
                    ITEM_SELECTED: 'ITEM_SELECTED',
                    DISPENSING: 'DISPENSING',
                    INSUFFICIENT_FUNDS: 'INSUFFICIENT_FUNDS',
                    OUT_OF_STOCK: 'OUT_OF_STOCK',
                    RETURNING_CHANGE: 'RETURNING_CHANGE'
                };

                // Input Symbols (Œ£)
                this.INPUTS = {
                    INSERT_COIN: 'INSERT_COIN',
                    SELECT_ITEM: 'SELECT_ITEM',
                    CANCEL: 'CANCEL',
                    CONFIRM_PURCHASE: 'CONFIRM_PURCHASE',
                    RESET: 'RESET',
                    COLLECT_CHANGE: 'COLLECT_CHANGE'
                };

                // Initial state
                this.state = this.STATES.IDLE;
                
                // Machine data
                this.balance = 0;
                this.selectedItem = null;
                this.change = 0;
                this.transactionHistory = [];
                
                // Products inventory
                this.products = [
                    { id: 'A1', name: 'Cola', price: 25.00, stock: 5, icon: 'ü•§' },
                    { id: 'A2', name: 'Diet Cola', price: 24.00, stock: 3, icon: 'ü•§' },
                    { id: 'A3', name: 'Lemonade', price: 22.00, stock: 4, icon: 'üßÉ' },
                    { id: 'B1', name: 'Chips', price: 30.00, stock: 6, icon: 'üçü' },
                    { id: 'B2', name: 'Chocolate', price: 35.00, stock: 4, icon: 'üç´' },
                    { id: 'B3', name: 'Cookies', price: 28.00, stock: 0, icon: 'üç™' },
                    { id: 'C1', name: 'Water', price: 20.00, stock: 8, icon: 'üíß' },
                    { id: 'C2', name: 'Energy Drink', price: 40.00, stock: 2, icon: '‚ö°' },
                    { id: 'C3', name: 'Juice', price: 27.00, stock: 3, icon: 'üßÉ' }
                ];

                // Database
                this.dbEnabled = true;
                this.checkDatabaseConnection();

                // Initialize
                this.initUI();
                this.updateDisplay();
                this.logEvent('Vending Machine initialized');
            }

            // Database Methods
            checkDatabaseConnection() {
                fetch('http://localhost:3000/api/health')
                    .then(res => res.json())
                    .then(data => {
                        this.dbEnabled = true;
                        console.log('‚úì Database connected');
                    })
                    .catch(err => {
                        this.dbEnabled = false;
                        console.warn('‚úó Database offline - running in memory only');
                    });
            }

            async saveTransaction(itemName, price, paid, change) {
                if (!this.dbEnabled) return;
                try {
                    await fetch('http://localhost:3000/api/transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ itemName, price, paid, change, type: 'TRANSACTION' })
                    });
                } catch (err) {
                    console.error('Error saving transaction:', err);
                }
            }

            async saveState(previousState, currentState, balance, selectedItem) {
                if (!this.dbEnabled) return;
                try {
                    await fetch('http://localhost:3000/api/state', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ previousState, currentState, balance, selectedItem })
                    });
                } catch (err) {
                    console.error('Error saving state:', err);
                }
            }

            async saveLogEvent(message) {
                if (!this.dbEnabled) return;
                try {
                    await fetch('http://localhost:3000/api/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });
                } catch (err) {
                    console.error('Error saving log:', err);
                }
            }

            async getHistory() {
                try {
                    const res = await fetch('http://localhost:3000/api/history');
                    return await res.json();
                } catch (err) {
                    console.error('Error retrieving history:', err);
                    return null;
                }
            }

            async clearHistory() {
                try {
                    await fetch('http://localhost:3000/api/history/clear', { method: 'POST' });
                    this.logEvent('Machine history cleared');
                } catch (err) {
                    console.error('Error clearing history:', err);
                }
            }

            // Transition Function (Œ¥)
            transition(input, data = null) {
                const previousState = this.state;
                
                switch (this.state) {
                    case this.STATES.IDLE:
                        if (input === this.INPUTS.INSERT_COIN) {
                            this.balance += data;
                            this.state = this.STATES.COIN_INSERTED;
                            this.logEvent(`Inserted ‚Ç±${data.toFixed(2)}, Balance: ‚Ç±${this.balance.toFixed(2)}`);
                        }
                        break;

                    case this.STATES.COIN_INSERTED:
                        if (input === this.INPUTS.INSERT_COIN) {
                            this.balance += data;
                            this.logEvent(`Added ‚Ç±${data.toFixed(2)}, Total: ‚Ç±${this.balance.toFixed(2)}`);
                        } else if (input === this.INPUTS.SELECT_ITEM) {
                            const product = this.products.find(p => p.id === data);
                            if (product) {
                                if (product.stock === 0) {
                                    this.state = this.STATES.OUT_OF_STOCK;
                                    this.logEvent(`${product.name} is OUT OF STOCK`);
                                } else if (this.balance >= product.price) {
                                    this.selectedItem = product;
                                    this.state = this.STATES.ITEM_SELECTED;
                                    this.logEvent(`Selected: ${product.name} - ‚Ç±${product.price.toFixed(2)}`);
                                } else {
                                    this.state = this.STATES.INSUFFICIENT_FUNDS;
                                    const needed = (product.price - this.balance).toFixed(2);
                                    this.logEvent(`INSUFFICIENT FUNDS: Need ‚Ç±${needed} more`);
                                }
                            }
                        } else if (input === this.INPUTS.CANCEL) {
                            this.change = this.balance;
                            this.balance = 0;
                            this.state = this.STATES.RETURNING_CHANGE;
                            this.logEvent(`Transaction cancelled. Change: ‚Ç±${this.change.toFixed(2)}`);
                        }
                        break;

                    case this.STATES.ITEM_SELECTED:
                        if (input === this.INPUTS.CONFIRM_PURCHASE) {
                            this.state = this.STATES.DISPENSING;
                            this.logEvent(`Dispensing ${this.selectedItem.name}...`);
                            this.dispenseItem();
                        } else if (input === this.INPUTS.CANCEL) {
                            this.state = this.STATES.RETURNING_CHANGE;
                            this.change = this.balance;
                            this.balance = 0;
                            this.selectedItem = null;
                            this.logEvent(`Purchase cancelled. Change: $${this.change.toFixed(2)}`);
                        }
                        break;

                    case this.STATES.INSUFFICIENT_FUNDS:
                        if (input === this.INPUTS.INSERT_COIN) {
                            this.balance += data;
                            this.state = this.STATES.COIN_INSERTED;
                            this.logEvent(`Added ‚Ç±${data.toFixed(2)}. Balance: ‚Ç±${this.balance.toFixed(2)}`);
                        } else if (input === this.INPUTS.CANCEL) {
                            this.state = this.STATES.RETURNING_CHANGE;
                            this.change = this.balance;
                            this.balance = 0;
                            this.logEvent(`Cancelled. Change: ‚Ç±${this.change.toFixed(2)}`);
                        }
                        break;

                    case this.STATES.OUT_OF_STOCK:
                        if (input === this.INPUTS.RESET) {
                            this.selectedItem = null;
                            this.state = this.STATES.IDLE;
                            this.logEvent('Returning to IDLE state');
                        }
                        break;

                    case this.STATES.DISPENSING:
                        // Auto-transition handled by dispenseItem()
                        break;

                    case this.STATES.RETURNING_CHANGE:
                        if (input === this.INPUTS.COLLECT_CHANGE) {
                            this.logEvent(`Collected ‚Ç±${this.change.toFixed(2)} in change`);
                            this.change = 0;
                            this.selectedItem = null;
                            this.state = this.STATES.IDLE;
                        }
                        break;
                }

                // Reset from any state
                if (input === this.INPUTS.RESET) {
                    const oldBalance = this.balance;
                    const oldChange = this.change;
                    this.balance = 0;
                    this.change = 0;
                    this.selectedItem = null;
                    this.state = this.STATES.IDLE;
                    this.logEvent(`MACHINE RESET. Refunded: Balance ‚Ç±${oldBalance}, Change ‚Ç±${oldChange}`);
                }

                if (previousState !== this.state) {
                    this.logEvent(`State: ${previousState} ‚Üí ${this.state}`);
                    this.saveState(previousState, this.state, this.balance, this.selectedItem?.name || null);
                }

                this.updateDisplay();
                this.updateButtonStates();
            }

            // Helper methods
            dispenseItem() {
                // Show animation
                const animation = document.getElementById('dispensingAnimation');
                animation.style.display = 'flex';
                
                // Update inventory
                this.selectedItem.stock--;
                this.change = this.balance - this.selectedItem.price;
                
                // Save transaction
                const itemPrice = this.selectedItem.price;
                const paidAmount = itemPrice + this.change;
                this.saveTransaction(this.selectedItem.name, itemPrice, paidAmount, this.change);
                
                // Log transaction
                this.transactionHistory.push({
                    item: this.selectedItem.name,
                    price: this.selectedItem.price,
                    time: new Date().toISOString()
                });

                setTimeout(() => {
                    animation.style.display = 'none';
                    this.logEvent(`Enjoy your ${this.selectedItem.name}!`);
                    this.state = this.STATES.RETURNING_CHANGE;
                    this.balance = 0;
                    this.updateDisplay();
                    this.updateButtonStates();
                    
                    if (this.change > 0) {
                        this.logEvent(`Change to return: ‚Ç±${this.change.toFixed(2)}`);
                    }
                }, 2000);
            }

            logEvent(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
                
                const logDiv = document.getElementById('outputLog');
                logDiv.prepend(logEntry);
                
                // Save to database
                this.saveLogEvent(message);
                
                // Keep only last 15 entries
                const entries = logDiv.querySelectorAll('.log-entry');
                if (entries.length > 15) {
                    entries[entries.length - 1].remove();
                }
            }

            // UI Methods
            initUI() {
                // Generate products grid
                const productsGrid = document.getElementById('productsGrid');
                this.products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.className = `product-item ${product.stock === 0 ? 'out-of-stock' : ''}`;
                    productDiv.dataset.id = product.id;
                    productDiv.innerHTML = `
                        <div class="product-icon">${product.icon}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">‚Ç±${product.price.toFixed(2)}</div>
                        <div class="product-stock">Stock: ${product.stock}</div>
                        <div class="product-id">${product.id}</div>
                    `;
                    productDiv.addEventListener('click', () => {
                        if (product.stock > 0 && this.state !== this.STATES.OUT_OF_STOCK) {
                            this.transition(this.INPUTS.SELECT_ITEM, product.id);
                        }
                    });
                    productsGrid.appendChild(productDiv);
                });

                // Coin buttons
                document.querySelectorAll('.coin-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const amount = parseFloat(btn.dataset.amount);
                        this.transition(this.INPUTS.INSERT_COIN, amount);
                    });
                });

                // Control buttons
                document.getElementById('confirmBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.CONFIRM_PURCHASE);
                });

                document.getElementById('cancelBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.CANCEL);
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.RESET);
                });

                document.getElementById('collectChangeBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.COLLECT_CHANGE);
                });

                document.getElementById('historyBtn').addEventListener('click', () => {
                    this.displayHistory();
                });

                document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear all machine history?')) {
                        this.clearHistory();
                    }
                });

                // Update inventory display
                this.updateInventoryDisplay();
            }

            updateDisplay() {
                // Update displays
                document.getElementById('balanceDisplay').textContent = `‚Ç±${this.balance.toFixed(2)}`;
                document.getElementById('currentState').textContent = this.state;
                
                if (this.selectedItem) {
                    document.getElementById('selectedItemDisplay').textContent = this.selectedItem.name;
                    document.getElementById('itemPriceDisplay').textContent = `‚Ç±${this.selectedItem.price.toFixed(2)}`;
                } else {
                    document.getElementById('selectedItemDisplay').textContent = '-';
                    document.getElementById('itemPriceDisplay').textContent = '‚Ç±0.00';
                }
                
                document.getElementById('changeDisplay').textContent = `‚Ç±${this.change.toFixed(2)}`;

                // Update product selection
                document.querySelectorAll('.product-item').forEach(item => {
                    item.classList.remove('selected');
                    if (this.selectedItem && item.dataset.id === this.selectedItem.id) {
                        item.classList.add('selected');
                    }
                    
                    // Update stock display
                    const product = this.products.find(p => p.id === item.dataset.id);
                    if (product) {
                        const stockEl = item.querySelector('.product-stock');
                        if (stockEl) {
                            stockEl.textContent = `Stock: ${product.stock}`;
                        }
                        item.classList.toggle('out-of-stock', product.stock === 0);
                    }
                });

                // Update inventory display
                this.updateInventoryDisplay();
            }

            updateInventoryDisplay() {
                const inventoryDiv = document.getElementById('inventoryDisplay');
                inventoryDiv.innerHTML = this.products.map(product => `
                    <div class="inventory-item">
                        <span>${product.icon} ${product.name} (${product.id})</span>
                        <span>‚Ç±${product.price.toFixed(2)} | Stock: ${product.stock}</span>
                    </div>
                `).join('');
            }

            updateButtonStates() {
                const confirmBtn = document.getElementById('confirmBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                const resetBtn = document.getElementById('resetBtn');
                const collectBtn = document.getElementById('collectChangeBtn');

                // Enable/disable based on state
                confirmBtn.disabled = this.state !== this.STATES.ITEM_SELECTED;
                cancelBtn.disabled = ![this.STATES.COIN_INSERTED, this.STATES.ITEM_SELECTED, this.STATES.INSUFFICIENT_FUNDS].includes(this.state);
                collectBtn.disabled = this.change === 0;
                resetBtn.disabled = false;

                // Enable/disable coin buttons
                document.querySelectorAll('.coin-btn').forEach(btn => {
                    btn.disabled = ![this.STATES.IDLE, this.STATES.COIN_INSERTED, this.STATES.INSUFFICIENT_FUNDS].includes(this.state);
                });

                // Enable/disable product buttons
                document.querySelectorAll('.product-item').forEach(item => {
                    const product = this.products.find(p => p.id === item.dataset.id);
                    if (product) {
                        item.style.pointerEvents = [this.STATES.COIN_INSERTED, this.STATES.INSUFFICIENT_FUNDS].includes(this.state) && product.stock > 0 ? 'auto' : 'none';
                    }
                });
            }

            displayHistory() {
                this.getHistory().then(history => {
                    if (history && history.transactions) {
                        const msg = `üìä MACHINE HISTORY\n\nTotal Transactions: ${history.transactions.length}\nStarted: ${history.startTime}\n\n${history.transactions.map((t, i) => `${i+1}. [${new Date(t.timestamp).toLocaleTimeString()}] ${t.type || 'EVENT'}\n   ${JSON.stringify(t).substring(0, 80)}...`).join('\n\n')}`;
                        alert(msg);
                        
                        // Also download
                        this.downloadHistory(history);
                    } else {
                        alert('No history available. Start the server to save history.');
                    }
                });
            }

            downloadHistory(history) {
                const json = JSON.stringify(history, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `machine_history_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Initialize vending machine when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.vendingMachine = new VendingMachine();
        });
    </script>
</body>
</html>