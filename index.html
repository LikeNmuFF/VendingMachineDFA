<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vending Machine Simulation - Automata Theory</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü•§ Vending Machine Simulation</h1>
            <p class="subtitle">Deterministic Finite Automata - Automata Theory CS 109</p>
        </header>

        <div class="machine-wrapper">
            <div class="vending-machine">
                <div class="machine-header">SUPER VEND 3000</div>
                
                <div class="display-panel">
                    <div class="display-row">
                        <span class="display-label">Balance:</span>
                        <span class="display-value" id="balanceDisplay">‚Ç±0.00</span>
                    </div>
                    <div class="display-row">
                        <span class="display-label">Selected Item:</span>
                        <span class="display-value" id="selectedItemDisplay">-</span>
                    </div>
                    <div class="display-row">
                        <span class="display-label">Item Price:</span>
                        <span class="display-value" id="itemPriceDisplay">‚Ç±0.00</span>
                    </div>
                </div>

                <div class="state-display">
                    <div class="state-label">Current State:</div>
                    <div class="state-value" id="currentState">IDLE</div>
                </div>

                <h2 class="section-title">Products Available</h2>
                <div class="products-grid" id="productsGrid">
                    <!-- Products will be generated by JavaScript -->
                </div>

                <div class="inventory-panel">
                    <h3 class="section-title">üì¶ Inventory Status</h3>
                    <div id="inventoryDisplay">
                        <!-- Inventory items will be displayed here -->
                    </div>
                </div>

                <div class="dispensing-animation" id="dispensingAnimation">
                    <div class="item-icon" id="dispensedItemIcon">ü•§</div>
                    <div class="item-name" id="dispensedItemName"></div>
                </div>
            </div>

            <div class="control-panel">
                <div class="coin-section">
                    <h3 class="section-title">üí∞ Insert Coins</h3>
                    <div class="coins-grid">
                        <button class="coin-btn" data-amount="5" title="‚Ç±5">
                            <img src="5.png" alt="‚Ç±5 coin">
                        </button>
                        <button class="coin-btn" data-amount="10" title="‚Ç±10">
                            <img src="10.png" alt="‚Ç±10 coin">
                        </button>
                        <button class="coin-btn" data-amount="20" title="‚Ç±20">
                            <img src="20.png" alt="‚Ç±20 coin">
                        </button>
                    </div>
                </div>

                <div class="dfa-definition">
                    <h3 class="section-title">üî∑ DFA Definition</h3>
                    <div class="dfa-components">
                        <div class="dfa-item">
                            <span class="dfa-symbol">Q</span>
                            <span class="dfa-description">Set of states</span>
                        </div>
                        <div class="dfa-item">
                            <span class="dfa-symbol">Œ£</span>
                            <span class="dfa-description">Set of input symbols</span>
                        </div>
                        <div class="dfa-item">
                            <span class="dfa-symbol">Œ¥</span>
                            <span class="dfa-description">Transition function (Q √ó Œ£ ‚Üí Q)</span>
                        </div>
                        <div class="dfa-item">
                            <span class="dfa-symbol">q‚ÇÄ</span>
                            <span class="dfa-description">Initial state</span>
                        </div>
                        <div class="dfa-item">
                            <span class="dfa-symbol">F</span>
                            <span class="dfa-description">Set of final/accepting states</span>
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="action-btn" id="confirmBtn">
                        <span>‚úÖ</span> Confirm Purchase
                    </button>
                    <button class="action-btn cancel-btn" id="cancelBtn">
                        <span>‚ùå</span> Cancel
                    </button>
                    <button class="action-btn reset-btn" id="resetBtn">
                        <span>üîÑ</span> Reset Machine
                    </button>
                    <button class="action-btn" id="collectChangeBtn">
                        <span>üí∞</span> Collect Change
                    </button>

                </div>

                <div class="output-section">
                    <h3 class="section-title">Output Log</h3>
                    <div class="output-area" id="outputLog">
                        <!-- Log entries will appear here -->
                    </div>
                </div>

                <div class="order-section">
                    <h3 class="section-title">Order Out</h3>
                    <div class="order-box" id="orderBox">
                        <!-- Dispensed items will appear here -->
                    </div>
                    <div style="text-align:center; margin-top:10px;">
                        <button class="action-btn" id="clearOrderBtn">Clear Order Box</button>
                    </div>
                </div>

                <div class="change-area">
                    <h3 class="section-title">üí∞ Change Return</h3>
                    <div class="change-display" id="changeDisplay">
                        ‚Ç±0.00
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VendingMachine {
            constructor() {
                // States (Q) - Deterministic Finite Automaton States
                this.STATES = {
                    IDLE: 'IDLE',                      // q0: Initial state
                    COIN_INSERTED: 'COIN_INSERTED',    // q1: Money in machine
                    ITEM_SELECTED: 'ITEM_SELECTED',    // q2: Item chosen (sufficient funds)
                    DISPENSING: 'DISPENSING',          // q3: Dispensing item
                    RETURNING_CHANGE: 'RETURNING_CHANGE' // q4: Returning change
                };

                // Input Symbols (Œ£) - Each symbol is DETERMINISTIC and context-specific
                // This ensures transitions are purely based on input, not data conditions
                this.INPUTS = {
                    // Coins (context-specific)
                    COIN_5: 'COIN_5',
                    COIN_10: 'COIN_10',
                    COIN_20: 'COIN_20',
                    
                    // Item selections (context-specific)
                    SELECT_ITEM: 'SELECT_ITEM',  // Data param specifies which item
                    
                    // Control actions
                    CONFIRM: 'CONFIRM',
                    CANCEL: 'CANCEL',
                    RESET: 'RESET',
                    COLLECT_CHANGE: 'COLLECT_CHANGE'
                };
                
                // DFA Transition Table: Œ¥(state, input) ‚Üí new_state
                // This is the formal DFA definition
                this.transitionTable = {
                    'IDLE': {
                        'COIN_5': 'COIN_INSERTED',
                        'COIN_10': 'COIN_INSERTED',
                        'COIN_20': 'COIN_INSERTED',
                        'RESET': 'IDLE'
                    },
                    'COIN_INSERTED': {
                        'COIN_5': 'COIN_INSERTED',
                        'COIN_10': 'COIN_INSERTED',
                        'COIN_20': 'COIN_INSERTED',
                        'SELECT_ITEM': 'ITEM_SELECTED',  // Validation happens separately
                        'CANCEL': 'RETURNING_CHANGE',
                        'RESET': 'IDLE'
                    },
                    'ITEM_SELECTED': {
                        'CONFIRM': 'DISPENSING',
                        'CANCEL': 'RETURNING_CHANGE',
                        'RESET': 'IDLE'
                    },
                    'DISPENSING': {
                        // Auto-transition to RETURNING_CHANGE after dispensing
                    },
                    'RETURNING_CHANGE': {
                        'COLLECT_CHANGE': 'IDLE',
                        'RESET': 'IDLE'
                    }
                };

                // Initial state
                this.state = this.STATES.IDLE;
                
                // Machine data
                this.balance = 0;
                this.selectedItem = null;
                this.change = 0;
                this.transactionHistory = [];
                // Control whether logs appear live in the UI
                // Set to true to show events in the Output-area (`outputLog`)
                this.uiLogEnabled = true;
                
                // Products inventory
                this.products = [
                    { id: 'A1', name: 'Cola', price: 25.00, stock: 5, icon: 'ü•§' },
                    { id: 'A2', name: 'Diet Cola', price: 24.00, stock: 3, icon: 'ü•§' },
                    { id: 'C2', name: 'Energy Drink', price: 40.00, stock: 2, icon: '‚ö°' }
                    
                ];

                // Database
                this.dbEnabled = true;
                this.checkDatabaseConnection();

                // Initialize
                this.initUI();
                this.updateDisplay();
                this.logEvent('Vending Machine initialized');
            }

            // Database Methods
            checkDatabaseConnection() {
                fetch('http://localhost:3000/api/health')
                    .then(res => res.json())
                    .then(data => {
                        this.dbEnabled = true;
                        console.log('‚úì Database connected');
                    })
                    .catch(err => {
                        this.dbEnabled = false;
                        console.warn('‚úó Database offline - running in memory only');
                    });
            }

            async saveTransaction(itemName, price, paid, change) {
                if (!this.dbEnabled) return;
                try {
                    await fetch('http://localhost:3000/api/transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ itemName, price, paid, change, type: 'TRANSACTION' })
                    });
                } catch (err) {
                    console.error('Error saving transaction:', err);
                }
            }

            async saveState(previousState, currentState, balance, selectedItem) {
                if (!this.dbEnabled) return;
                try {
                    await fetch('http://localhost:3000/api/state', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ previousState, currentState, balance, selectedItem })
                    });
                } catch (err) {
                    console.error('Error saving state:', err);
                }
            }

            async saveLogEvent(message) {
                if (!this.dbEnabled) return;
                try {
                    await fetch('http://localhost:3000/api/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });
                } catch (err) {
                    console.error('Error saving log:', err);
                }
            }

            async getHistory() {
                try {
                    const res = await fetch('http://localhost:3000/api/history');
                    return await res.json();
                } catch (err) {
                    console.error('Error retrieving history:', err);
                    return null;
                }
            }

            async clearHistory() {
                try {
                    await fetch('http://localhost:3000/api/history/clear', { method: 'POST' });
                    this.logEvent('Machine history cleared');
                } catch (err) {
                    console.error('Error clearing history:', err);
                }
            }

            // Transition Function (Œ¥) - TRUE DFA: (state, input) ‚Üí state
            transition(input, data = null) {
                const previousState = this.state;
                
                // Look up deterministic transition in DFA table
                const nextState = this.transitionTable[this.state]?.[input];
                
                // If no valid transition for this (state, input) pair, stay in current state
                if (!nextState) {
                    // Log invalid transition
                    if (input === this.INPUTS.SELECT_ITEM && previousState === this.STATES.COIN_INSERTED) {
                        // Special handling: validation error messages don't change state
                        const product = this.products.find(p => p.id === data);
                        if (product) {
                            if (product.stock === 0) {
                                this.logEvent(`‚ùå ${product.name} is OUT OF STOCK - cannot select`);
                            } else if (this.balance < product.price) {
                                const needed = (product.price - this.balance).toFixed(2);
                                this.logEvent(`‚ùå INSUFFICIENT FUNDS: Need ‚Ç±${needed} more for ${product.name}`);
                            }
                        }
                    }
                    return; // Stay in current state
                }
                
                // Handle specific input types
                switch (input) {
                    case this.INPUTS.COIN_5:
                        this.balance += 5;
                        this.logEvent(`Inserted ‚Ç±5.00 ‚Üí Balance: ‚Ç±${this.balance.toFixed(2)}`);
                        break;
                    case this.INPUTS.COIN_10:
                        this.balance += 10;
                        this.logEvent(`Inserted ‚Ç±10.00 ‚Üí Balance: ‚Ç±${this.balance.toFixed(2)}`);
                        break;
                    case this.INPUTS.COIN_20:
                        this.balance += 20;
                        this.logEvent(`Inserted ‚Ç±20.00 ‚Üí Balance: ‚Ç±${this.balance.toFixed(2)}`);
                        break;
                    
                    case this.INPUTS.SELECT_ITEM:
                        const product = this.products.find(p => p.id === data);
                        if (product) {
                            this.selectedItem = product;
                            this.logEvent(`‚úì Selected: ${product.name} - ‚Ç±${product.price.toFixed(2)}`);
                        }
                        break;
                    
                    case this.INPUTS.CONFIRM:
                        if (this.selectedItem) {
                            this.logEvent(`Dispensing ${this.selectedItem.name}...`);
                        }
                        break;
                    
                    case this.INPUTS.CANCEL:
                        this.change = this.balance;
                        this.balance = 0;
                        this.selectedItem = null;
                        this.logEvent(`Transaction cancelled. Change: ‚Ç±${this.change.toFixed(2)}`);
                        break;
                    
                    case this.INPUTS.RESET:
                        const oldBalance = this.balance;
                        const oldChange = this.change;
                        this.balance = 0;
                        this.change = 0;
                        this.selectedItem = null;
                        this.logEvent(`üîÑ MACHINE RESET. Refunded: ‚Ç±${oldBalance + oldChange}`);
                        break;
                    
                    case this.INPUTS.COLLECT_CHANGE:
                        this.logEvent(`Collected ‚Ç±${this.change.toFixed(2)} in change`);
                        this.change = 0;
                        break;
                }
                
                // Apply DFA transition
                this.state = nextState;
                
                // Handle dispensing completion
                if (this.state === this.STATES.DISPENSING) {
                    this.dispenseItem();
                }
                
                // Log state transition
                if (previousState !== this.state) {
                    this.logEvent(`[FSM] ${previousState} ‚Üí ${this.state}`);
                    this.saveState(previousState, this.state, this.balance, this.selectedItem?.name || null);
                }

                this.updateDisplay();
                this.updateButtonStates();
            }

            // Helper methods
            dispenseItem() {
                // Show animation and set dispensed icon/name
                const animation = document.getElementById('dispensingAnimation');
                const iconEl = document.getElementById('dispensedItemIcon');
                const nameEl = document.getElementById('dispensedItemName');
                if (iconEl) iconEl.textContent = this.selectedItem.icon || 'üç´';
                if (nameEl) nameEl.textContent = this.selectedItem.name || '';
                // Ensure animation restarts
                animation.style.display = 'flex';
                animation.style.animation = 'none';
                // force reflow
                // eslint-disable-next-line no-unused-expressions
                animation.offsetWidth;
                animation.style.animation = '';

                // Update inventory
                this.selectedItem.stock--;
                // Raw change computation
                let rawChange = this.balance - this.selectedItem.price;

                // Detect anomalies: NaN, infinite, negative
                if (!isFinite(rawChange) || Number.isNaN(rawChange)) {
                    this.logEvent(`‚ùó CHANGE_CALC_ERROR: invalid change value (${rawChange}). Setting change to ‚Ç±0.00`);
                    rawChange = 0;
                }

                // Round to 2 decimals for currency
                const roundedChange = Number(rawChange.toFixed(2));

                // Log rounding differences (floating point issues)
                if (Math.abs(roundedChange - rawChange) > 0.000001) {
                    this.logEvent(`‚ö†Ô∏è CHANGE_ROUNDING: computed=${rawChange} ‚Üí rounded=‚Ç±${roundedChange.toFixed(2)}`);
                }

                // If negative (shouldn't happen), clamp and log
                if (roundedChange < 0) {
                    this.logEvent(`‚ùå CHANGE_NEGATIVE: computed change ‚Ç±${roundedChange.toFixed(2)} < 0 ‚Äî correcting to ‚Ç±0.00`);
                    this.change = 0;
                } else {
                    this.change = roundedChange;
                }

                // Save transaction (paid amount is item price + change returned)
                const itemPrice = this.selectedItem.price;
                const paidAmount = Number((itemPrice + this.change).toFixed(2));
                this.saveTransaction(this.selectedItem.name, itemPrice, paidAmount, this.change);

                // Log transaction summary in history
                this.transactionHistory.push({
                    item: this.selectedItem.name,
                    price: this.selectedItem.price,
                    paid: paidAmount,
                    change: this.change,
                    time: new Date().toISOString()
                });

                setTimeout(() => {
                    animation.style.display = 'none';
                    // clear icon/name after animation completes
                    if (iconEl) iconEl.textContent = 'ü•§';
                    if (nameEl) nameEl.textContent = '';

                    // Show OUT message in output area and also log normally
                    this.showOutMessage(`OUT ‚Üí ${this.selectedItem.name}`);
                    this.logEvent(`Enjoy your ${this.selectedItem.name}!`);
                    this.state = this.STATES.RETURNING_CHANGE;
                    this.balance = 0;
                    this.updateDisplay();
                    this.updateButtonStates();

                    if (this.change > 0) {
                        this.logEvent(`Change to return: ‚Ç±${this.change.toFixed(2)}`);
                    }

                    // Add dispensed item to order chute
                    this.addOrderEntry({
                        icon: this.selectedItem.icon || 'ü•§',
                        name: this.selectedItem.name,
                        time: new Date().toLocaleTimeString()
                    });
                }, 2000);
            }

            addOrderEntry(entry) {
                const orderBox = document.getElementById('orderBox');
                if (!orderBox) return;
                const div = document.createElement('div');
                div.className = 'order-entry';
                div.innerHTML = `<div class="order-icon">${entry.icon}</div><div class="order-name">${entry.name}</div><div class="order-time">${entry.time}</div>`;
                orderBox.prepend(div);
                // keep last 10
                const entries = orderBox.querySelectorAll('.order-entry');
                if (entries.length > 10) entries[entries.length - 1].remove();
            }

            logEvent(message) {
                const timestamp = new Date().toLocaleTimeString();
                // Persist log to server/text file always
                this.saveLogEvent(message);

                // If UI logging is enabled, also show in the output panel
                if (this.uiLogEnabled) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;

                    // Highlight change-calculation related messages
                    const changeKeywords = ['Change', 'CHANGE', 'CHANGE_ROUNDING', 'CHANGE_CALC_ERROR', 'CHANGE_NEGATIVE', 'Change to return', 'Collected'];
                    if (changeKeywords.some(k => message.includes(k))) {
                        logEntry.classList.add('change-log-entry');
                    }

                    const logDiv = document.getElementById('outputLog');
                    logDiv.prepend(logEntry);

                    // Keep only last 15 entries in the UI
                    const entries = logDiv.querySelectorAll('.log-entry');
                    if (entries.length > 15) {
                        entries[entries.length - 1].remove();
                    }
                }
            }

            // Show a single OUT message in the output area and clear previous entries
            showOutMessage(message) {
                const logDiv = document.getElementById('outputLog');
                if (!logDiv) return;
                // Clear existing entries
                logDiv.innerHTML = '';
                const outEntry = document.createElement('div');
                outEntry.className = 'out-entry';
                const timestamp = new Date().toLocaleTimeString();
                outEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
                logDiv.prepend(outEntry);
            }

            // UI Methods
            initUI() {
                // Generate products grid
                const productsGrid = document.getElementById('productsGrid');
                this.products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.className = `product-item ${product.stock === 0 ? 'out-of-stock' : ''}`;
                    productDiv.dataset.id = product.id;
                    productDiv.innerHTML = `
                        <div class="product-icon">${product.icon}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">‚Ç±${product.price.toFixed(2)}</div>
                        <div class="product-stock">Stock: ${product.stock}</div>
                        <div class="product-id">${product.id}</div>
                    `;
                    productDiv.addEventListener('click', () => {
                        if (product.stock > 0 && this.state !== this.STATES.OUT_OF_STOCK) {
                            this.transition(this.INPUTS.SELECT_ITEM, product.id);
                        }
                    });
                    productsGrid.appendChild(productDiv);
                });

                // Coin buttons
                document.querySelectorAll('.coin-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const amount = parseFloat(btn.dataset.amount);
                        if (amount === 5) this.transition(this.INPUTS.COIN_5);
                        else if (amount === 10) this.transition(this.INPUTS.COIN_10);
                        else if (amount === 20) this.transition(this.INPUTS.COIN_20);
                    });
                });

                // Control buttons
                document.getElementById('confirmBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.CONFIRM);
                });

                document.getElementById('cancelBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.CANCEL);
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.RESET);
                });

                document.getElementById('collectChangeBtn').addEventListener('click', () => {
                    this.transition(this.INPUTS.COLLECT_CHANGE);
                });

                document.getElementById('historyBtn').addEventListener('click', () => {
                    // Load server text log instead of showing live UI logs
                    this.displayTextLog();
                });

                document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear all machine history?')) {
                        this.clearTextLog();
                        // also clear the order box
                        const orderBox = document.getElementById('orderBox');
                        if (orderBox) orderBox.innerHTML = '';
                    }
                });

                // Clear order box button
                document.getElementById('clearOrderBtn').addEventListener('click', () => {
                    if (confirm('Clear the order output?')) {
                        const orderBox = document.getElementById('orderBox');
                        if (orderBox) orderBox.innerHTML = '';
                    }
                });

                // Update inventory display
                this.updateInventoryDisplay();
            }

            updateDisplay() {
                // Update displays
                document.getElementById('balanceDisplay').textContent = `‚Ç±${this.balance.toFixed(2)}`;
                document.getElementById('currentState').textContent = this.state;
                
                if (this.selectedItem) {
                    document.getElementById('selectedItemDisplay').textContent = this.selectedItem.name;
                    document.getElementById('itemPriceDisplay').textContent = `‚Ç±${this.selectedItem.price.toFixed(2)}`;
                } else {
                    document.getElementById('selectedItemDisplay').textContent = '-';
                    document.getElementById('itemPriceDisplay').textContent = '‚Ç±0.00';
                }
                
                document.getElementById('changeDisplay').textContent = `‚Ç±${this.change.toFixed(2)}`;

                // Update product selection
                document.querySelectorAll('.product-item').forEach(item => {
                    item.classList.remove('selected');
                    if (this.selectedItem && item.dataset.id === this.selectedItem.id) {
                        item.classList.add('selected');
                    }
                    
                    // Update stock display
                    const product = this.products.find(p => p.id === item.dataset.id);
                    if (product) {
                        const stockEl = item.querySelector('.product-stock');
                        if (stockEl) {
                            stockEl.textContent = `Stock: ${product.stock}`;
                        }
                        item.classList.toggle('out-of-stock', product.stock === 0);
                    }
                });

                // Update inventory display
                this.updateInventoryDisplay();
            }

            updateInventoryDisplay() {
                const inventoryDiv = document.getElementById('inventoryDisplay');
                inventoryDiv.innerHTML = this.products.map(product => `
                    <div class="inventory-item">
                        <span>${product.icon} ${product.name} (${product.id})</span>
                        <span>‚Ç±${product.price.toFixed(2)} | Stock: ${product.stock}</span>
                    </div>
                `).join('');
            }

            updateButtonStates() {
                const confirmBtn = document.getElementById('confirmBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                const resetBtn = document.getElementById('resetBtn');
                const collectBtn = document.getElementById('collectChangeBtn');

                // Enable/disable based on state (DFA states)
                confirmBtn.disabled = this.state !== this.STATES.ITEM_SELECTED;
                cancelBtn.disabled = ![this.STATES.COIN_INSERTED, this.STATES.ITEM_SELECTED].includes(this.state);
                collectBtn.disabled = this.change === 0;
                resetBtn.disabled = false;

                // Enable/disable coin buttons (valid in IDLE, COIN_INSERTED)
                document.querySelectorAll('.coin-btn').forEach(btn => {
                    btn.disabled = ![this.STATES.IDLE, this.STATES.COIN_INSERTED].includes(this.state);
                });

                // Enable/disable product buttons (valid in COIN_INSERTED with sufficient funds)
                document.querySelectorAll('.product-item').forEach(item => {
                    const product = this.products.find(p => p.id === item.dataset.id);
                    if (product) {
                        const canSelect = this.state === this.STATES.COIN_INSERTED && 
                                        product.stock > 0 && 
                                        this.balance >= product.price;
                        item.style.pointerEvents = canSelect ? 'auto' : 'none';
                        item.style.opacity = canSelect ? '1' : '0.5';
                    }
                });
            }

            // Fetch and display the server text log (machine_history.txt)
            async displayTextLog() {
                
                

            }

            displayHistory() {
                this.getHistory().then(history => {
                    if (history && history.transactions) {
                        const msg = `üìä MACHINE HISTORY\n\nTotal Transactions: ${history.transactions.length}\nStarted: ${history.startTime}\n\n${history.transactions.map((t, i) => `${i+1}. [${new Date(t.timestamp).toLocaleTimeString()}] ${t.type || 'EVENT'}\n   ${JSON.stringify(t).substring(0, 80)}...`).join('\n\n')}`;
                        alert(msg);
                        
                        // Also download
                        this.downloadHistory(history);
                    } else {
                        alert('No history available. Start the server to save history.');
                    }
                });
            }

            downloadHistory(history) {
                const json = JSON.stringify(history, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `machine_history_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Initialize vending machine when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.vendingMachine = new VendingMachine();
        });
    </script>
</body>
</html>